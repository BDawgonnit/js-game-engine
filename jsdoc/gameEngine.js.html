<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>gameEngine.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-AssetManager-AssetManager.html">AssetManager</a><ul class='methods'><li data-type='method'><a href="module-AssetManager-AssetManager.html#downloadAll">downloadAll</a></li><li data-type='method'><a href="module-AssetManager-AssetManager.html#getAsset">getAsset</a></li><li data-type='method'><a href="module-AssetManager-AssetManager.html#init">init</a></li><li data-type='method'><a href="module-AssetManager-AssetManager.html#isDone">isDone</a></li><li data-type='method'><a href="module-AssetManager-AssetManager.html#queueDownload">queueDownload</a></li><li data-type='method'><a href="module-AssetManager-AssetManager.html#queueDownloads">queueDownloads</a></li></ul></li><li><a href="module-Engine-GameEngine.html">GameEngine</a><ul class='methods'><li data-type='method'><a href="module-Engine-GameEngine.html#addEntity">addEntity</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#addEntitySubset">addEntitySubset</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#addSystem">addSystem</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#addSystems">addSystems</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#getAssetPaths">getAssetPaths</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#getEntities">getEntities</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#onAssetsLoaded">onAssetsLoaded</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#removeEntity">removeEntity</a></li><li data-type='method'><a href="module-Engine-GameEngine.html#run">run</a></li></ul></li><li><a href="module-EntityManager-EntityManager.html">EntityManager</a><ul class='methods'><li data-type='method'><a href="module-EntityManager-EntityManager.html#addEntity">addEntity</a></li><li data-type='method'><a href="module-EntityManager-EntityManager.html#addEntitySubset">addEntitySubset</a></li><li data-type='method'><a href="module-EntityManager-EntityManager.html#getEntities">getEntities</a></li><li data-type='method'><a href="module-EntityManager-EntityManager.html#removeEntity">removeEntity</a></li></ul></li><li><a href="module-Entity-Entity.html">Entity</a><ul class='methods'><li data-type='method'><a href="module-Entity-Entity.html#addComponent">addComponent</a></li><li data-type='method'><a href="module-Entity-Entity.html#getComponent">getComponent</a></li><li data-type='method'><a href="module-Entity-Entity.html#hasComponent">hasComponent</a></li><li data-type='method'><a href="module-Entity-Entity.html#removeComponent">removeComponent</a></li></ul></li><li><a href="module-ExampleEntityFactory-ExampleEntityFactory.html">ExampleEntityFactory</a><ul class='methods'><li data-type='method'><a href="module-ExampleEntityFactory-ExampleEntityFactory.html#create">create</a></li></ul></li><li><a href="module-ExampleSpawnerSystem-ExampleSpawnerSystem.html">ExampleSpawnerSystem</a><ul class='methods'><li data-type='method'><a href="module-ExampleSpawnerSystem-ExampleSpawnerSystem.html#getRequiredSubsets">getRequiredSubsets</a></li><li data-type='method'><a href="module-ExampleSpawnerSystem-ExampleSpawnerSystem.html#run">run</a></li></ul></li><li><a href="module-RenderSystem-ExampleRenderSystem.html">ExampleRenderSystem</a><ul class='methods'><li data-type='method'><a href="module-RenderSystem-ExampleRenderSystem.html#getAssetPaths">getAssetPaths</a></li><li data-type='method'><a href="module-RenderSystem-ExampleRenderSystem.html#getRequiredSubsets">getRequiredSubsets</a></li><li data-type='method'><a href="module-RenderSystem-ExampleRenderSystem.html#onAssetsLoaded">onAssetsLoaded</a></li><li data-type='method'><a href="module-RenderSystem-ExampleRenderSystem.html#run">run</a></li></ul></li><li><a href="module-TiledMap-TiledMap.html">TiledMap</a><ul class='methods'><li data-type='method'><a href="module-TiledMap-TiledMap.html#getAssetPaths">getAssetPaths</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#onAssetsLoaded">onAssetsLoaded</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#populateLayerCanvases">populateLayerCanvases</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#populateLayers">populateLayers</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#populateTiles">populateTiles</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#render">render</a></li><li data-type='method'><a href="module-TiledMap-TiledMap.html#renderAnimatedTiles">renderAnimatedTiles</a></li></ul></li><li><a href="module-utilities-Utilities.html">Utilities</a><ul class='methods'><li data-type='method'><a href="module-utilities-Utilities.html#createArray">createArray</a></li><li data-type='method'><a href="module-utilities-Utilities.html#createIterableObject">createIterableObject</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-AssetManager.html">AssetManager</a></li><li><a href="module-AssetUser.html">AssetUser</a></li><li><a href="module-Engine.html">Engine</a></li><li><a href="module-Entity.html">Entity</a></li><li><a href="module-EntityFactory.html">EntityFactory</a></li><li><a href="module-EntityManager.html">EntityManager</a></li><li><a href="module-ExampleEntityFactory.html">ExampleEntityFactory</a></li><li><a href="module-ExampleSpawnerSystem.html">ExampleSpawnerSystem</a></li><li><a href="module-RenderSystem.html">RenderSystem</a></li><li><a href="module-System.html">System</a></li><li><a href="module-TiledMap.html">TiledMap</a></li><li><a href="module-utilities.html">utilities</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-AssetUser-AssetUser.html">AssetUser</a><ul class='methods'><li data-type='method'><a href="module-AssetUser-AssetUser.html#getAssetPaths">getAssetPaths</a></li><li data-type='method'><a href="module-AssetUser-AssetUser.html#onAssetsLoaded">onAssetsLoaded</a></li></ul></li><li><a href="module-EntityFactory-EntityFactory.html">EntityFactory</a><ul class='methods'><li data-type='method'><a href="module-EntityFactory-EntityFactory.html#create">create</a></li></ul></li><li><a href="module-System-System.html">System</a><ul class='methods'><li data-type='method'><a href="module-System-System.html#addEntity">addEntity</a></li><li data-type='method'><a href="module-System-System.html#getEntities">getEntities</a></li><li data-type='method'><a href="module-System-System.html#getRequiredSubsets">getRequiredSubsets</a></li><li data-type='method'><a href="module-System-System.html#removeEntity">removeEntity</a></li><li data-type='method'><a href="module-System-System.html#run">run</a></li><li data-type='method'><a href="module-System-System.html#setEntityManager">setEntityManager</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">gameEngine.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * GameEngine module.
 * @module Engine
 */
define('GameEngine', function(module) {
	'use strict';

	const AssetUser = require('AssetUser');
	const EntityManager = require('EntityManager');
	const assetManager = new (require('AssetManager'))();
	const TiledMap = require('TiledMap');

	/** Class representing a Game Engine. */
	class GameEngine extends AssetUser {

		/**
		 * Create a Game Engine.
		 * @param {string} mapPath - URL to the map JSON data.
		 * @param {EntityFactory} entityFactory - Instance of an EntityFactory. Used when calling addEntity() method.
		 */
		constructor(mapPath, entityFactory) {
			super();
			this.mapPath = mapPath;
			this.loadingPhase = 0;
			this.runAfterLoad = false;
			this.systems = {};
			this.entityManager = new EntityManager(entityFactory);

			// Queue downloads for overall game....Should this be somehow combined with the addSystems() logic? I copied and edited this logic from there
			let loop = () => {
				let pathsOrObjs = this.getAssetPaths();
				if(!this.loaded) {
					if(pathsOrObjs.length > 0) {
						assetManager.queueDownloads(pathsOrObjs);
					}
					let paths = pathsOrObjs.map(function(pathOrObj) {
						return pathOrObj.path ? pathOrObj.path : pathOrObj; // Ensure each item is a path string
					});

					assetManager.downloadAll(() => {
						let assets = {};
						paths.forEach(function(pathStr) {
							assets[pathStr] = assetManager.getAsset(pathStr);
						});

						this.onAssetsLoaded(assets);

						if(!this.loaded) { loop(); return; }

						this.addSystems();
					});
				}
			};
			loop();

		}

		/**
		 * @returns {array}  Array of path strings or plain objects with a "path" and "reviver" function (for JSON)
		 */
		getAssetPaths() {
			switch(this.loadingPhase) {
				case 0:
					return [{
						path: this.mapPath,
						reviver: function(data) {
							return new TiledMap(data);
						}
					}];
				case 1:
					return this.map.getAssetPaths();
			}
		}

		/**
		 * Event handler function - Store downloaded assets
		 * @param {Object} assets - Plain object that works as an associative array. Each item key is a path from "getAssetPaths()"
		 */
		onAssetsLoaded(assets) {
			let objects;

			switch(this.loadingPhase) {
				case 0:
					this.map = assets[this.mapPath];
					break;
				case 1:
					this.map.onAssetsLoaded(assets);

					// Create entities for each object type
					objects = this.map.getObjects();
					for(let object of objects) {
						this.addEntity(object.type, object);
					}

					super.onAssetsLoaded();
					break;
			}
			this.loadingPhase++;
		}

		/**
		 * Get an array of Entity instances.
		 * @param  {string=} subsetName - Name of entity subset.
		 * @returns {Entity[]}  Entity instances for this game.
		 */
		getEntities(subsetName) {
			return this.entityManager.getEntities(subsetName);
		}

		/**
		 * Create a subset of the Entity array for this game.
		 * @param  {string} subsetName - Name of component used to get subset.
		 * @param  {function} mapper - Function to help determine if an Entity should be a part of this subset.
		 */
		addEntitySubset(subsetName, mapper) {
			this.entityManager.addEntitySubset(subsetName, mapper);
		}

		/**
		 * Add an Entity.
		 * @param  {string} entityType - Type of Entity to add to this game.
		 * @param {Object} data - Plain object representing the component data.
		 * @returns {Entity}  Entity that was added
		 */
		addEntity(entityType, data) {
			return this.entityManager.addEntity(entityType, data);
		}

		/**
		 * Remove an Entity.
		 * @param {Entity}  entity - Entity instance to be removed
		 */
		removeEntity(entity) {
			this.entityManager.removeEntity(entity);
		}

		/**
		 * Adds a System to this game.
		 * @param {string} systemName - Key to use for the system.
		 * @param {System} system - System to add
		 */
		addSystem(systemName, system) {
			this.systems[systemName] = system;

			let subsets = system.getRequiredSubsets();
			for(let subsetKey in subsets) {
				let mapper = subsets[subsetKey];
				this.addEntitySubset(subsetKey, mapper);
			}

			// Share the same entityManager instance with each system
			system.setEntityManager(this.entityManager);
		}

		/**
		 * Instantiate and add Systems for this game.
		 */
		addSystems() {
			let loop = () => {
				let callbackObjs = [];

				// Queue downloads for each system, keep track of callbacks
				for(let systemKey in this.systems) {
					let system = this.systems[systemKey];
					let pathsOrObjs = system.getAssetPaths();
					if(!system.loaded) {
						if(pathsOrObjs.length > 0) {
							assetManager.queueDownloads(pathsOrObjs);
						}
						callbackObjs.push({
							system: system,
							paths: pathsOrObjs.map(function(pathOrObj) {
								return pathOrObj.path ? pathOrObj.path : pathOrObj; // Ensure each item is a path string
							})
						});
					}
				}

				// Download all queued assets, run callbacks (feed requested assets)
				assetManager.downloadAll(() => {
					let systemsLoaded = true;
					for(let callbackObj of callbackObjs) {

						let assets = {};
						callbackObj.paths.forEach(function(pathStr) {
							assets[pathStr] = assetManager.getAsset(pathStr);
						});

						callbackObj.system.onAssetsLoaded(assets);
						systemsLoaded = systemsLoaded &amp;&amp; callbackObj.system.loaded;
					}

					// If any system was not loaded, loop again
					if(!systemsLoaded) { loop(); return; }

					// Otherwise, flag engine as "loaded" and...
					this.loaded = true;

					// *call this.run() if an attempt was made to call this.run() before loading was completed
					if(this.runAfterLoad) { this.run(); }
				});
			};
			loop();
		}

		/**
		 * Fire main loop, which continuously iterates over and runs each System.
		 */
		run() {

			// *If we haven't finished loading, mark a flag to run after load and return
			if(!this.loaded) {
				this.runAfterLoad = true;
				return;
			}

			// Define the main loop function
			let main = (timestamp) => {

				// Loop over systems (ECS design pattern)
				for(let systemKey in this.systems) {
					this.systems[systemKey].run(timestamp);
				}

				// Keep loop going by making an asynchronous, recursive call to main loop function
				window.requestAnimationFrame(main);
			};

			// Run main loop function
			main(performance.now());
		}
	}

	module.exports = GameEngine;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Tue Nov 08 2016 18:39:47 GMT-0500 (Eastern Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
